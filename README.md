# Generate UCSC Genome Browser Links with Borzoi Prediction Tracks

The dependencies for this code should all be contained in the Borzoi installation. Too install Borzoi, see https://github.com/calico/borzoi. Otherwise, activate the Borzoi Conda env using 

```
conda activate borzoi_env_name
```

The required data to run this code is data/y_wt.tsv and data/y_mut.tsv. These matrices are obtained from the Borzoi output predictions. See src/track_pred.py for how to generate them (including normalization and track aggregation). The columns are tissue ids (must be unique if you don't aggreate the tissues) and the rows are bins. To use new data, place newly generated tsv files in the data directory with the same name.

You also need to authenticate Google Cloud. See here: https://cloud.google.com/storage/docs/reference/libraries?authuser=1#client-libraries-install-python.

Basically, just use:

```
gcloud init
gcloud auth application-default login
```

You will be prompted to copy a link into your browser, login with your Calico email, and then you copy and paste your authentication link back into your cmd. Once you have authenticated, there will be a credential json stored locally and you will be able to use this code to upload to gCloud. Ignore warnings about quota.


To run the code:

```
python get_ucsc_link.py <chrom> <variant_position> <alt_allele> <offset> <path_to_installation> <borzoi_session_id[optional]>
```

Here is an example command line to reproduce the sQTL example from the Borzoi paper: see https://github.com/calico/borzoi/blob/main/examples/borzoi_example_sqtl_chr9_135548708_G_C.ipynb. The example data/y_wt.tsv and data/y_mut.tsv were generated by Borzoi for this example.

```
python get_ucsc_link.py chr9 135548708 C 16 /home/davidwang/hackweek2025 2429720455
```

The offset I used is 16 but you can set it to 0 if you don't use an offset.

To use the borzoi session id, just feed another argument. The example uses id 2429720455. You can see the matching files data/2429720455_y_wt.tsv and data/2429720455_y_mut.tsv.

To interface with this code, you can just use the create_ucsc_link function in src/get_ucsc_link.py. See the main for the parameters and usage. 

Here is an example link output: https://genome.ucsc.edu/cgi-bin/hgTracks?hgsid=2429631879_1NLe4jgjCh0YxzJMl5JNuSRcqzVk&position=chr9%3A135287076-135810340

Code logic

1. Start at src/get_ucsc_link.py
2. This calls src/track_pred.py to get the model output matrix, transforms the output, aggregates the tracks with the same tissues, and outputs this as a tsv in data/y_wt.tsv and data/y_mut.tsv 
3. Then it calls src/make_trackhub.py which generates the TrackHub directory structure with relevant metadata and the wig/bigwig files. See hubDirectory/<session_id> for an example. Then it pushes this directory to another git repo (this is getting replaced with gCloud).
4. src/get_ucsc_link.py will then submit a post request with the TrackHub hub.txt location as the payload to UCSC Genome Browser. This returns this hgsid session id which is appended to the link.  

